<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elephant Exchange Admin</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: var(--bg); color: #1e293b; }
        
        /* Layout Utils */
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
        .card { background: var(--card); padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Typography */
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        h2 { font-size: 1.25rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 0; }
        
        /* Forms */
        .input-group { display: flex; gap: 8px; margin-bottom: 16px; }
        input { flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; }
        button { cursor: pointer; background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #64748b; }

        /* Lists */
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        li:last-child { border-bottom: none; }
        
        .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 99px; background: #e2e8f0; color: #475569; }
        .badge.stolen { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <div id="login-section" class="card" style="max-width: 400px; margin: 40px auto; text-align: center;">
        <h1>üêò Elephant Exchange</h1>
        <p style="color: #64748b; margin-bottom: 20px;">Enter a Game ID to host or join.</p>
        <div class="input-group">
            <input type="text" id="gameIdInput" placeholder="e.g. acme-party" autofocus />
            <button onclick="joinGame()">Start</button>
        </div>
    </div>

    <div id="dashboard-section" class="hidden">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <div>
                <h1 style="margin:0;">Hosting: <span id="displayGameId" style="color: var(--primary);">...</span></h1>
                <small style="color: #64748b;">Share this ID with your guests</small>
            </div>
            <button class="secondary" onclick="location.reload()">Exit Game</button>
        </header>

        <div class="grid">
            <div class="card">
                <h2>üë• Participants</h2>
                <div class="input-group">
                    <input type="number" id="pNumber" placeholder="#" style="max-width: 60px;">
                    <input type="text" id="pName" placeholder="Name (e.g. Uncle Bob)">
                    <button onclick="addParticipant()">Add</button>
                </div>
                <ul id="participantList">
                    </ul>
            </div>

            <div class="card">
                <h2>üéÅ Gifts</h2>
                <div class="input-group">
                    <input type="text" id="gDesc" placeholder="Description (e.g. Red Toaster)">
                    <button onclick="addGift()">Add</button>
                </div>
                <ul id="giftList">
                    </ul>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentGameId = null;

        // --- AUTH & SETUP ---
        async function joinGame() {
            const gameId = document.getElementById('gameIdInput').value.trim();
            if(!gameId) return alert("Please enter a Game ID");

            // 1. Tell Server to Init Game
            const res = await fetch('/api/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ gameId })
            });

            if(res.ok) {
                currentGameId = gameId;
                // Switch Screens
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                document.getElementById('displayGameId').innerText = gameId;
                
                // Connect Realtime
                initSocket(gameId);
                refreshState();
            }
        }

        function initSocket(gameId) {
            socket = io();
            socket.emit('joinGame', gameId);
            
            // Listen for server updates
            socket.on('stateUpdate', (state) => {
                console.log("‚ö° Update received:", state);
                render(state);
            });
        }

        // --- DATA HANDLING ---
        async function refreshState() {
            const res = await fetch(`/api/${currentGameId}/state`);
            const state = await res.json();
            render(state);
        }

        function render(state) {
            // Render Participants
            const pList = document.getElementById('participantList');
            if (state.participants.length === 0) {
                pList.innerHTML = `<li style="color:#ccc; justify-content:center;">No participants yet</li>`;
            } else {
                pList.innerHTML = state.participants
                    .sort((a,b) => a.number - b.number) // Sort by #
                    .map(p => `
                    <li>
                        <span><b>#${p.number || '?'}</b> ${p.name}</span>
                        <span class="badge">${p.status}</span>
                    </li>
                `).join('');
            }

            // Render Gifts
            const gList = document.getElementById('giftList');
            if (state.gifts.length === 0) {
                gList.innerHTML = `<li style="color:#ccc; justify-content:center;">No gifts yet</li>`;
            } else {
                gList.innerHTML = state.gifts.map(g => `
                    <li>
                        <span>${g.description}</span>
                        <span class="badge ${g.stealCount > 0 ? 'stolen' : ''}">
                            ${g.stealCount > 0 ? `Stolen ${g.stealCount}x` : 'Wrapped'}
                        </span>
                    </li>
                `).join('');
            }
        }

        // --- USER ACTIONS ---
        async function addParticipant() {
            const numInput = document.getElementById('pNumber');
            const nameInput = document.getElementById('pName');
            
            if(!nameInput.value && !numInput.value) return;

            await fetch(`/api/${currentGameId}/participants`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    name: nameInput.value, 
                    number: numInput.value 
                })
            });

            // Clear inputs
            nameInput.value = '';
            numInput.value = '';
            nameInput.focus();
        }

        async function addGift() {
            const descInput = document.getElementById('gDesc');
            if(!descInput.value) return;

            await fetch(`/api/${currentGameId}/gifts`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ description: descInput.value })
            });

            descInput.value = '';
            descInput.focus();
        }

        // Allow "Enter" key to submit
        document.getElementById('gameIdInput').addEventListener('keypress', e => e.key === 'Enter' && joinGame());
        document.getElementById('pName').addEventListener('keypress', e => e.key === 'Enter' && addParticipant());
        document.getElementById('gDesc').addEventListener('keypress', e => e.key === 'Enter' && addGift());
    </script>
</body>
</html>