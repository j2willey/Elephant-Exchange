<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elephant Exchange - Host</title>
    <link rel="stylesheet" href="css/gameadmin.css">
    <style> body { overflow-x: auto !important; } </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="js/gamelib.js" defer></script>
    <script src="js/gameadmin.js" defer></script>
</head>
<body>

    <div id="login-section" class="login-container">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">ğŸ˜ Elephant Exchange</h1>
        <p style="color: #94a3b8; margin-bottom: 2rem;">The ultimate White Elephant party companion.</p>

        <div class="login-split-card">
            <div class="login-half left">
                <h2>ğŸ‰ Host a Party</h2>
                <p>Start a brand new game.</p>
                <div class="input-group">
                    <input type="text" id="hostNameInput" placeholder="e.g. Smith Family Xmas">
                    <input type="password" id="createPasswordInput" placeholder="Admin PIN (Optional)" style="max-width: 120px; margin-left: 5px;">
                    <button onclick="handleHostGame()" class="btn-nav">Create & Host ğŸš€</button>
                </div>
            </div>

            <div class="login-divider"><span>OR</span></div>

            <div class="login-half right">
                <h2>ğŸ•µï¸ Reconnect</h2>
                <p>Manage an existing game.</p>
                <div class="input-group">
                    <input type="text" id="joinNameInput" placeholder="Search Party Name...">
                    <button onclick="handleReconnectGame()" class="btn-nav">Search ğŸ”</button>
                </div>
                <div id="searchResults" style="margin-top:10px; text-align:left;"></div>
            </div>
        </div>
        <input type="hidden" id="gameIdInput">
    </div>

    <div id="dashboard-section" class="hidden">

        <header class="admin-banner">
            <h1 id="bannerTitle">Elephant Exchange</h1>
            <div id="bannerTagline" class="tagline"></div>
        </header>

        <div class="menu-bar">
            <div style="margin-right: auto; display: flex; gap: 8px; align-items: center;">
                <span class="menu-label">TV View:</span>
                <button id="btnTvRules"  onclick="setTvMode('rules')"   class="btn-ghost" title="Show Rules">Rules</button>
                <button id="btnTvQr"     onclick="setTvMode('qr')"      class="btn-ghost" title="Show Join QR">QR</button>
                <button id="btnTvGrid"   onclick="setTvMode('catalog')" class="btn-ghost" title="Show Grid View">Catalog</button>
                <button id="btnTvList"   onclick="setTvMode(null)"      class="btn-ghost active" title="Show Game List">Gifts</button>
            </div>

            <div style="display:flex; gap:10px; align-items: center;">
                <button onclick="showLocalQr()" class="btn-ghost" style="font-size:0.85rem;">Invite</button>
                <button onclick="openCatalog()" class="btn-ghost" style="font-size:0.85rem;">Catalog</button>
                <a href="/faq.html" target="_blank" class="icon-btn" title="Help / FAQ">â“</a>
                <button onclick="openThemeSettings()" class="icon-btn" title="Theme">ğŸ­</button>
                <button onclick="openSettings()" class="icon-btn" title="Game Settings">âš™ï¸</button>
            </div>
        </div>

        <div class="main-layout" id="mainLayout">
            <aside class="sidebar" id="leftPanel">
                <div class="card" style="height: 100%; overflow-y: auto;">
                    <h3>Participants</h3>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="number" id="pNumber" placeholder="#" style="width:60px; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                        <input type="text" id="pName" placeholder="Name" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                        <button onclick="addParticipant()" class="btn-nav">Add</button>
                    </div>
                    <ul id="participantList" class="participant-list"></ul>
                </div>
            </aside>

            <div class="resizer" id="dragHandle"></div>

            <main class="content" id="rightPanel">
                <div id="phaseControls" style="margin-bottom: 20px;"></div>

                <div class="card" style="height: 100%; overflow-y: auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>Gift Tracker</h3>
                    </div>
                    <ul id="giftList" class="gift-list"></ul>
                </div>
            </main>
        </div>

        <footer class="admin-footer">
            <button onclick="confirmEndGame()" class="btn-nav" title="End Game">ğŸ›‘ End Game</button>

            <div class="icon-legend">
                <span>ğŸ Open</span>
                <span>ğŸ˜ˆ Steal</span>
                <span>ğŸ•’ Reset Time</span>
                <span>â¤µï¸ Skip</span>
                <span>ğŸ—‘ï¸ Remove</span>
            </div>

            <div class="scale-control" style="display:flex; align-items:center; gap:10px;">
                <button onclick="resetLayout()" class="btn-ghost" style="font-size:0.75rem; padding:2px 6px;" title="Fix Layout Issues">Reset Layout</button>
                <span style="font-size:0.85rem; color:#6b7280;">Scale:</span>
                <input type="range" id="uiScale" min="0.5" max="1.5" step="0.1" value="1" style="width:80px;">
            </div>
        </footer>
    </div>

    <div id="settingsModal" class="admin-modal-overlay hidden">
        <div class="admin-modal-content">
            <h3 id="settingsModalTitle">Game Settings</h3>
            <div class="settings-grid">
                 <div class="setting-label-group"><label>Party Name</label></div><input type="text" id="settingPartyName">
                 <div class="setting-label-group"><label>Tagline</label></div><input type="text" id="settingTagline">
                 <div class="setting-label-group"><label>Turn Duration</label></div><input type="number" id="settingDuration">
                 <div class="setting-label-group"><label>Max Steals</label></div><input type="number" id="settingMaxSteals">
                 <div class="setting-label-group"><label>Active Players (Simultaneous Turns)</label></div><input type="number" id="settingActiveCount" placeholder="Default: 1">
                 <div class="setting-label-group"><label>Turn Order</label></div>
                 <label class="toggle-switch" style="width:100%;">
                    <input type="checkbox" id="settingGameModeToggle" onchange="toggleRosterInput()">
                    <span class="slider round"></span>
                    <span class="toggle-label" id="gameModeLabel" style="margin-left:10px;">Manual Numbers</span>
                </label>
                <div class="setting-label-group"><label>Total Players</label></div><input type="number" id="settingTotalPlayers" oninput="syncRosterFromCount()">
            </div>
            <div id="rosterInputSection" style="display:none; margin-top:10px;"><textarea id="settingRosterNames" rows="6" oninput="syncCountFromRoster()" style="width:100%;"></textarea></div>

            <div style="margin-top:25px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button id="btnCancelSettings" onclick="cancelSettings()" class="btn-nav">Cancel</button>
                <button id="btnSaveSettings" onclick="saveSettings()" class="btn-nav">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="themeModal" class="admin-modal-overlay hidden">
        <div class="admin-modal-content" style="max-width: 500px;">
            <h3>Party Theme & Branding</h3>

            <div class="settings-grid">
                <div style="grid-column: 1 / -1;">
                    <div class="setting-label-group"><label>Theme Preset</label></div>
                    <select id="themePresetSelect" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; background-color: #fff;">
                        <option value="custom">ğŸ› ï¸ Customized</option>
                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        </select>
                </div>

                <div class="setting-label-group"><label>Theme Color</label></div>
                <input type="color" id="themeColorInput" style="height:42px; width:100%; padding:2px;">

                <div class="setting-label-group" style="grid-column: 1 / -1; margin-top:10px;">
                    <label>TV Background Image (URL)</label>
                    <input type="text" id="themeBgInput" placeholder="https://..." style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>

            <div style="text-align:center; padding: 20px 0; border-bottom:1px solid #f3f4f6; margin-bottom:20px;">
                <label style="display:block; font-weight:600; margin-bottom:10px;">Projector Logo</label>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <input type="file" id="themeLogoInput" accept="image/*" style="font-size:0.9rem;">
                    <button onclick="uploadLogo()" class="btn-nav">Upload Logo</button>
                </div>
            </div>

            <div style="margin-top:25px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeThemeSettings()" class="btn-nav">Cancel</button>
                <button onclick="saveThemeSettings()" class="btn-nav">Save Theme</button>
            </div>
        </div>
    </div>

    <div id="lateArrivalModal" class="admin-modal-overlay hidden">
        <div class="admin-modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size:3rem; margin-bottom:10px;">â±ï¸</div>
            <h3>Late Arrival Detected</h3>
            <p>The game has already started. How should we insert <b id="latePlayerName"></b>?</p>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <button onclick="confirmLateAdd('random')" class="btn-nav">Insert Randomly (Fair)</button>
                <button onclick="confirmLateAdd('end')" class="btn-nav">Add to End (Standard)</button>
                <button onclick="closeLateModal()" class="btn-nav" style="background:white !important; color:#64748b !important; border-color:#e2e8f0 !important;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="localQrModal" class="admin-modal-overlay hidden">
        <div class="admin-modal-content" style="max-width:350px; text-align:center;">
            <h3 style="border:none;">ğŸ“± Private QR Code</h3>
            <p style="margin-bottom:20px;">Scan to join <b><span id="qrGameIdDisplay"></span></b></p>
            <div id="localQrcode" style="margin:0 auto 20px auto; display:inline-block; background: white; padding: 10px; border-radius: 8px;"></div>
            <br>
            <button onclick="closeLocalQr()" class="btn-nav" style="width:100%;">Close</button>
        </div>
    </div>

    <div id="imageModal" class="admin-modal-overlay hidden">
        <div class="admin-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
                <h3 id="imgModalTitle" style="margin:0;">Manage Images</h3>
                <button onclick="closeImgModal()" class="btn-nav" style="padding: 4px 10px; font-size: 1.2rem;">&times;</button>
            </div>
            <div id="imgList" class="admin-img-grid"></div>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; display:flex; gap:10px;">
                <input type="file" id="adminFileInput" accept="image/*" style="flex:1;">
                <button onclick="adminUpload()" class="btn-nav">Upload</button>
            </div>
        </div>
    </div>

    <div id="sysDialogModal" class="admin-modal-overlay hidden" style="z-index: 3000;">
        <div class="admin-modal-content" style="max-width: 400px; text-align: center;">
            <h3 id="sysDialogTitle" style="margin-top:0; border:none;">Notification</h3>
            <p id="sysDialogMessage" style="color:#4b5563; margin-bottom:20px; font-size:1.1rem;"></p>
            <input type="text" id="sysDialogInput" class="hidden" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #d1d5db; border-radius:6px; font-size:1rem;">
            <div id="sysDialogButtons" style="display:flex; justify-content:center; gap:10px;">
                <button id="btnSysCancel" class="btn-manage hidden">Cancel</button>
                <button id="btnSysOk" class="btn-play">OK</button>
            </div>
        </div>
    </div>

    <div id="openGiftModal" class="admin-modal-overlay hidden">
        <div class="admin-modal-content" style="max-width: 450px;">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:3rem;">ğŸ</div>
                <h3 id="giftModalTitle" style="margin:10px 0 0 0;">Gift Details</h3>
                <p id="giftModalSubtitle" style="color:#6b7280; margin:5px 0 0 0;">Enter the details below.</p>
            </div>

            <div style="display:flex; flex-direction:column; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-weight:600; font-size:0.9rem; color:#374151; display:block; margin-bottom:5px;">Name (Headline)</label>
                    <input type="text" id="giftNameInput" placeholder="e.g. Starbucks Gift Card" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; font-size:1.1rem;">
                </div>
                <div>
                    <label style="font-weight:600; font-size:0.9rem; color:#374151; display:block; margin-bottom:5px;">Description (Details)</label>
                    <input type="text" id="giftDescInput" placeholder="e.g. $25 value, includes mug" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>

            <div id="giftModalContext" style="background:#f3f4f6; color:#4b5563; padding:8px; border-radius:6px; font-size:0.9rem; text-align:center; margin-bottom:20px; font-weight:500;">
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeOpenGiftModal()" class="btn-manage" style="background:white !important; color:#6b7280 !important; border-color:#e5e7eb !important;">Cancel</button>
                <button onclick="submitGiftModal()" class="btn-play" style="padding-left:30px; padding-right:30px;">Save ğŸ’¾</button>
            </div>
        </div>
    </div>

    <div id="authModal" class="admin-modal-overlay hidden" style="z-index: 5000;">
        <div class="admin-modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ”’</div>
            <h3>Admin Access Required</h3>
            <p>This game is protected. Enter the Host PIN.</p>

            <input type="password" id="authPasswordInput"
                style="font-size: 1.5rem; text-align: center; letter-spacing: 4px; padding: 10px; width: 80%; margin: 15px 0; border: 2px solid #2563eb; border-radius: 8px;">

            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="submitAuthPassword()" class="btn-play" style="width: 100%;">Unlock</button>
            </div>
        </div>
    </div>

</body>
</html>